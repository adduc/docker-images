---
name: Gather Metadata

on:
  workflow_call:
    inputs:
      directory:
        required: true
        type: string
    outputs:
      is_image:
        description: 'Is this directory an image?'
        value: ${{ jobs.gather-metadata.outputs.is_image }}
      list:
        description: 'List of image variants in this directory'
        value: ${{ jobs.gather-metadata.outputs.list }}
      list_base:
        description: 'List of base image directories in this directory'
        value: ${{ jobs.gather-metadata.outputs.list_base }}
      list_baseless:
        description: 'List of non-base image directories in this directory'
        value: ${{ jobs.gather-metadata.outputs.list_baseless }}

jobs:
  gather-metadata:
    runs-on: ubuntu-24.04
    outputs:
      is_image: ${{ steps.gather-metadata.outputs.is_image }}
      list: ${{ steps.gather-metadata.outputs.list }}
      list_base: ${{ steps.gather-metadata.outputs.list_base }}
      list_baseless: ${{ steps.gather-metadata.outputs.list_baseless }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Prepare .env file
        shell: bash
        run: |
          set -o pipefail -o errexit -o nounset
          cp .ci.env .env

      - name: Calculate Outputs
        id: calculation
        shell: bash
        run: |
          set -o pipefail -o errexit -o nounset
          cd ${{ inputs.directory }}
          [ -f Dockerfile ] && IS_IMAGE="true" || IS_IMAGE="false"

          echo "is_image=$IS_IMAGE" | tee -a $GITHUB_OUTPUT
          echo "list=$(make list | jq -R -c 'split(" ")')" | tee -a $GITHUB_OUTPUT
          echo "list_base=$(make list-base | jq -R -c 'split(" ")')" | tee -a $GITHUB_OUTPUT
          echo "list_baseless=$(make list-baseless | jq -R -c 'split(" ")')" | tee -a $GITHUB_OUTPUT
